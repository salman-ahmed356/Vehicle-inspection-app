{% include 'report_sections/expertises/vehicle_header.html' %}

<h2 class="text-lg font-semibold mb-4">
  {{ expertise_report.expertise_type.name }} Paint Inspection
</h2>
<p class="mb-4">Click on car parts to mark their paint condition</p>

<div class="car-container">
  <svg width="400" height="600" viewBox="0 0 400 600" xmlns="http://www.w3.org/2000/svg">
    <!-- Exact replica of the reference car image -->
    
    <!-- Front Bumper (Top Red) -->
    <rect class="car-part" onclick="openModal('Front Bumper', this)" 
          x="140" y="30" width="120" height="25" 
          fill="#dc3545" stroke="#333" stroke-width="2" rx="12"/>
    <rect x="145" y="35" width="110" height="15" 
          fill="none" stroke="#333" stroke-width="1" rx="8"/>
    
    <!-- Main car body outline -->
    <path d="M120 70 Q100 70 100 90 L100 140 Q90 150 90 160 L90 200 Q90 210 100 220 L100 260 Q90 270 90 280 L90 320 Q90 330 100 340 L100 380 Q90 390 90 400 L90 440 Q90 450 100 460 L100 500 Q100 520 120 520 L280 520 Q300 520 300 500 L300 460 Q310 450 310 440 L310 400 Q310 390 300 380 L300 340 Q310 330 310 320 L310 280 Q310 270 300 260 L300 220 Q310 210 310 200 L310 160 Q310 150 300 140 L300 90 Q300 70 280 70 Z" 
          fill="none" stroke="#333" stroke-width="3"/>
    
    <!-- Hood -->
    <path class="car-part" onclick="openModal('Hood', this)" 
          d="M140 55 L260 55 L290 70 Q290 90 270 110 L260 130 L140 130 L130 110 Q110 90 110 70 Z" 
          fill="#b3d9ff" stroke="#333" stroke-width="2"/>
    
    <!-- Front Windshield -->
    <path d="M140 130 L260 130 L240 170 L160 170 Z" 
          fill="#b3d9ff" stroke="#333" stroke-width="1" opacity="0.8"/>
    
    <!-- Left Front Fender -->
    <path class="car-part" onclick="openModal('Left Front Fender', this)" 
          d="M100 90 Q90 90 90 100 L90 140 Q90 160 110 160 L140 160 L140 130 Q120 110 110 100 Q105 90 100 90 Z" 
          fill="#ffffff" stroke="#333" stroke-width="2"/>
    
    <!-- Right Front Fender -->
    <path class="car-part" onclick="openModal('Right Front Fender', this)" 
          d="M300 90 Q310 90 310 100 L310 140 Q310 160 290 160 L260 160 L260 130 Q280 110 290 100 Q295 90 300 90 Z" 
          fill="#ffffff" stroke="#333" stroke-width="2"/>
    
    <!-- Left Front Door -->
    <path class="car-part" onclick="openModal('Left Front Door', this)" 
          d="M90 160 Q90 170 100 180 L100 240 Q90 250 90 260 L90 300 Q90 310 100 310 L140 310 L140 160 Z" 
          fill="#ffffff" stroke="#333" stroke-width="2"/>
    
    <!-- Right Front Door -->
    <path class="car-part" onclick="openModal('Right Front Door', this)" 
          d="M260 160 L300 160 L300 310 Q310 310 310 300 L310 260 Q310 250 300 240 L300 180 Q310 170 310 160 Z" 
          fill="#ffffff" stroke="#333" stroke-width="2"/>
    
    <!-- Roof -->
    <path class="car-part" onclick="openModal('Roof', this)" 
          d="M140 170 L260 170 L260 310 L140 310 Z" 
          fill="#ffffff" stroke="#333" stroke-width="2"/>
    
    <!-- Left Rear Door -->
    <path class="car-part" onclick="openModal('Left Rear Door', this)" 
          d="M90 310 Q90 320 100 330 L100 390 Q90 400 90 410 L90 450 Q90 460 100 460 L140 460 L140 310 Z" 
          fill="#ffffff" stroke="#333" stroke-width="2"/>
    
    <!-- Right Rear Door -->
    <path class="car-part" onclick="openModal('Right Rear Door', this)" 
          d="M260 310 L300 310 L300 460 Q310 460 310 450 L310 410 Q310 400 300 390 L300 330 Q310 320 310 310 Z" 
          fill="#ffffff" stroke="#333" stroke-width="2"/>
    
    <!-- Trunk Lid -->
    <path class="car-part" onclick="openModal('Trunk Lid', this)" 
          d="M140 430 L260 430 L290 460 Q290 480 270 500 L260 520 L140 520 L130 500 Q110 480 110 460 Z" 
          fill="#b3d9ff" stroke="#333" stroke-width="2"/>
    
    <!-- Rear Windshield -->
    <path d="M140 430 L260 430 L240 470 L160 470 Z" 
          fill="#b3d9ff" stroke="#333" stroke-width="1" opacity="0.8"/>
    
    <!-- Left Rear Fender -->
    <path class="car-part" onclick="openModal('Left Rear Fender', this)" 
          d="M100 460 Q90 460 90 470 L90 510 Q90 530 110 530 L140 530 L140 500 Q120 480 110 470 Q105 460 100 460 Z" 
          fill="#ffffff" stroke="#333" stroke-width="2"/>
    
    <!-- Right Rear Fender -->
    <path class="car-part" onclick="openModal('Right Rear Fender', this)" 
          d="M300 460 Q310 460 310 470 L310 510 Q310 530 290 530 L260 530 L260 500 Q280 480 290 470 Q295 460 300 460 Z" 
          fill="#ffffff" stroke="#333" stroke-width="2"/>
    
    <!-- Rear Bumper (Bottom Red) -->
    <rect class="car-part" onclick="openModal('Rear Bumper', this)" 
          x="140" y="545" width="120" height="25" 
          fill="#dc3545" stroke="#333" stroke-width="2" rx="12"/>
    <rect x="145" y="550" width="110" height="15" 
          fill="none" stroke="#333" stroke-width="1" rx="8"/>
    
    <!-- Wheels -->
    <circle cx="130" cy="140" r="20" fill="#666" stroke="#333" stroke-width="2"/>
    <circle cx="130" cy="140" r="12" fill="#999" stroke="#333" stroke-width="1"/>
    
    <circle cx="270" cy="140" r="20" fill="#666" stroke="#333" stroke-width="2"/>
    <circle cx="270" cy="140" r="12" fill="#999" stroke="#333" stroke-width="1"/>
    
    <circle cx="130" cy="460" r="20" fill="#666" stroke="#333" stroke-width="2"/>
    <circle cx="130" cy="460" r="12" fill="#999" stroke="#333" stroke-width="1"/>
    
    <circle cx="270" cy="460" r="20" fill="#666" stroke="#333" stroke-width="2"/>
    <circle cx="270" cy="460" r="12" fill="#999" stroke="#333" stroke-width="1"/>
  </svg>
  
  <div class="legend">
    <div class="legend-item">
      <div class="legend-color" style="background-color: #ffffff; border: 2px solid #333;"></div>
      <span>Original Paint</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #dc3545;"></div>
      <span>Repainted</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #ffc107;"></div>
      <span>Portion Repainted</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #0066cc;"></div>
      <span>Foiled</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #fd7e14;"></div>
      <span>Damaged</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #6c757d;"></div>
      <span>Not Available</span>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="partModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Select Status</h3>
    <div class="status-options">
      <div class="status-option" onclick="selectStatus('Original', this)">
        <div class="status-color" style="background-color: #ffffff; border: 2px solid #333;"></div>
        <span>Original Paint</span>
      </div>
      <div class="status-option" onclick="selectStatus('Painted', this)">
        <div class="status-color" style="background-color: #dc3545;"></div>
        <span>Repainted</span>
      </div>
      <div class="status-option" onclick="selectStatus('Locally Painted', this)">
        <div class="status-color" style="background-color: #ffc107;"></div>
        <span>Portion Repainted</span>
      </div>
      <div class="status-option" onclick="selectStatus('Replaced', this)">
        <div class="status-color" style="background-color: #0066cc;"></div>
        <span>Foiled</span>
      </div>
      <div class="status-option" onclick="selectStatus('Damaged', this)">
        <div class="status-color" style="background-color: #fd7e14;"></div>
        <span>Damaged</span>
      </div>
      <div class="status-option" onclick="selectStatus('None', this)">
        <div class="status-color" style="background-color: #6c757d;"></div>
        <span>Not Available</span>
      </div>
    </div>
    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveStatus()">Save</button>
    </div>
  </div>
</div>

<form id="expertiseForm" method="POST" action="{{ url_for('reports.expertise_detail', expertise_report_id=expertise_report.id) }}">
  <input type="hidden" name="current_expertise_type" value="{{ current_expertise_type }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  
  {% for feature in expertise_report.features %}
    <input type="hidden" name="feature_{{ feature.id }}" id="feature_{{ feature.id }}" value="{{ feature.status }}">
  {% endfor %}
  
  <div class="mb-4">
    <label for="technician_comment" class="block text-gray-700 font-semibold mb-2">
      Technician Comment
    </label>
    <textarea
      id="technician_comment"
      name="technician_comment"
      rows="4"
      class="w-full p-2 border border-gray-300 rounded"
      placeholder="Enter technician comment here..."
    >{{ expertise_report.comment }}</textarea>
  </div>

  <div class="flex justify-end mt-4">
    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">
      Save
    </button>
  </div>
</form>

<style>
.car-container {
  display: flex;
  gap: 30px;
  align-items: flex-start;
  justify-content: center;
  margin: 20px 0;
  background: #f8f9fa;
  padding: 20px;
  border-radius: 10px;
}

.car-part {
  cursor: pointer;
  transition: all 0.3s ease;
}

.car-part:hover {
  opacity: 0.8;
  stroke-width: 3;
}

.legend {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  min-width: 200px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
}

.legend-color {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 2px solid #333;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
}

.modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 20px;
  border-radius: 10px;
  min-width: 300px;
}

.status-options {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin: 15px 0;
}

.status-option {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  border: 2px solid #ddd;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.status-option:hover {
  border-color: #007bff;
  background: #f8f9fa;
}

.status-option.selected {
  border-color: #007bff;
  background: #007bff;
  color: white;
}

.status-color {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 2px solid #333;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
}

.btn-primary {
  background: #007bff;
  color: white;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

@media (max-width: 768px) {
  .car-container {
    flex-direction: column;
    align-items: center;
  }
  
  .legend {
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    min-width: auto;
  }
}
</style>

<script>
let currentPart = null;
let selectedStatus = null;

// Feature mapping
const partFeatureMap = {
  {% for feature in expertise_report.features %}
  '{{ feature.name }}': {{ feature.id }},
  {% endfor %}
};

const statusColors = {
  'Original': '#ffffff',
  'Painted': '#dc3545',
  'Locally Painted': '#ffc107',
  'Replaced': '#0066cc',
  'Damaged': '#fd7e14',
  'None': '#6c757d'
};

function openModal(partName, partElement) {
  console.log('Opening modal for:', partName);
  currentPart = partElement;
  document.getElementById('modalTitle').textContent = partName;
  document.getElementById('partModal').style.display = 'block';
  
  // Clear previous selection
  document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'));
  selectedStatus = null;
}

function closeModal() {
  document.getElementById('partModal').style.display = 'none';
  currentPart = null;
  selectedStatus = null;
}

function selectStatus(status, element) {
  document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'));
  element.classList.add('selected');
  selectedStatus = status;
  console.log('Selected status:', status);
}

function saveStatus() {
  if (!currentPart || !selectedStatus) {
    alert('Please select a status');
    return;
  }
  
  const partName = currentPart.getAttribute('onclick').match(/'([^']+)'/)[1];
  const featureId = partFeatureMap[partName];
  console.log('Part name:', partName, 'Feature ID:', featureId);
  
  if (featureId) {
    // Update hidden form input
    const hiddenInput = document.getElementById('feature_' + featureId);
    if (hiddenInput) {
      hiddenInput.value = selectedStatus;
      console.log('Updated hidden input:', hiddenInput.name, '=', selectedStatus);
    }
    
    // Update visual appearance
    currentPart.style.fill = statusColors[selectedStatus];
    console.log('Updated', partName, 'to', selectedStatus, 'with color', statusColors[selectedStatus]);
  }
  
  closeModal();
}

// Initialize parts with current status
document.addEventListener('DOMContentLoaded', function() {
  console.log('Initializing car parts...');
  {% for feature in expertise_report.features %}
  const partName = '{{ feature.name }}';
  const status = '{{ feature.status }}';
  const color = statusColors[status] || '#ffffff';
  
  // Find the part element by onclick attribute
  const partElements = document.querySelectorAll('.car-part');
  partElements.forEach(function(element) {
    const onclick = element.getAttribute('onclick');
    if (onclick && onclick.includes(partName)) {
      element.style.fill = color;
      console.log('Initialized', partName, 'with color', color);
    }
  });
  {% endfor %}
  
  // Form submission handler
  const form = document.getElementById('expertiseForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      
      fetch(this.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams(formData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Paint expertise updated successfully!');
        } else {
          alert('Update failed: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Update failed. Please check your inputs!');
      });
    });
  }
});
</script>