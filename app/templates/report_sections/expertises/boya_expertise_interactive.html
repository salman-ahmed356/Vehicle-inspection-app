{% include 'report_sections/expertises/vehicle_header.html' %}

<h2 class="text-lg font-semibold mb-4">
  {{ expertise_report.expertise_type.name }} Paint Inspection
</h2>
<p class="mb-4">Click on car parts to mark their paint condition</p>

<div class="car-inspection-container">
  <div class="car-diagram">
    <!-- Using a professional car inspection diagram -->
    <svg width="500" height="700" viewBox="0 0 500 700" xmlns="http://www.w3.org/2000/svg">
      <!-- Car outline -->
      <path d="M150 100 Q130 100 130 120 L130 180 Q120 190 120 200 L120 250 Q120 260 130 270 L130 320 Q120 330 120 340 L120 390 Q120 400 130 410 L130 460 Q120 470 120 480 L120 530 Q120 540 130 550 L130 600 Q130 620 150 620 L350 620 Q370 620 370 600 L370 550 Q380 540 380 530 L380 480 Q380 470 370 460 L370 410 Q380 400 380 390 L380 340 Q380 330 370 320 L370 270 Q380 260 380 250 L380 200 Q380 190 370 180 L370 120 Q370 100 350 100 Z" 
            fill="none" stroke="#333" stroke-width="3"/>
      
      <!-- Front Bumper -->
      <rect id="front-bumper" class="car-part" data-part="Front Bumper"
            x="180" y="80" width="140" height="30" 
            fill="#ffffff" stroke="#333" stroke-width="2" rx="15"/>
      <text x="250" y="100" text-anchor="middle" font-size="12" fill="#333">Front Bumper</text>
      
      <!-- Hood -->
      <path id="hood" class="car-part" data-part="Hood"
            d="M180 110 L320 110 L350 130 Q350 150 330 170 L320 190 L180 190 L170 170 Q150 150 150 130 Z" 
            fill="#ffffff" stroke="#333" stroke-width="2"/>
      <text x="250" y="155" text-anchor="middle" font-size="12" fill="#333">Hood</text>
      
      <!-- Left Front Fender -->
      <path id="left-front-fender" class="car-part" data-part="Left Front Fender"
            d="M130 120 Q120 120 120 130 L120 180 Q120 200 140 200 L180 200 L180 160 Q160 140 150 130 Q140 120 130 120 Z" 
            fill="#ffffff" stroke="#333" stroke-width="2"/>
      <text x="140" y="165" text-anchor="middle" font-size="10" fill="#333">L Front Fender</text>
      
      <!-- Right Front Fender -->
      <path id="right-front-fender" class="car-part" data-part="Right Front Fender"
            d="M370 120 Q380 120 380 130 L380 180 Q380 200 360 200 L320 200 L320 160 Q340 140 350 130 Q360 120 370 120 Z" 
            fill="#ffffff" stroke="#333" stroke-width="2"/>
      <text x="360" y="165" text-anchor="middle" font-size="10" fill="#333">R Front Fender</text>
      
      <!-- Left Front Door -->
      <path id="left-front-door" class="car-part" data-part="Left Front Door"
            d="M120 200 Q120 210 130 220 L130 280 Q120 290 120 300 L120 340 Q120 350 130 350 L180 350 L180 200 Z" 
            fill="#ffffff" stroke="#333" stroke-width="2"/>
      <text x="140" y="280" text-anchor="middle" font-size="10" fill="#333">L Front Door</text>
      
      <!-- Right Front Door -->
      <path id="right-front-door" class="car-part" data-part="Right Front Door"
            d="M320 200 L370 200 L370 350 Q380 350 380 340 L380 300 Q380 290 370 280 L370 220 Q380 210 380 200 Z" 
            fill="#ffffff" stroke="#333" stroke-width="2"/>
      <text x="360" y="280" text-anchor="middle" font-size="10" fill="#333">R Front Door</text>
      
      <!-- Roof -->
      <path id="roof" class="car-part" data-part="Roof"
            d="M180 200 L320 200 L320 350 L180 350 Z" 
            fill="#ffffff" stroke="#333" stroke-width="2"/>
      <text x="250" y="280" text-anchor="middle" font-size="12" fill="#333">Roof</text>
      
      <!-- Left Rear Door -->
      <path id="left-rear-door" class="car-part" data-part="Left Rear Door"
            d="M120 350 Q120 360 130 370 L130 430 Q120 440 120 450 L120 490 Q120 500 130 500 L180 500 L180 350 Z" 
            fill="#ffffff" stroke="#333" stroke-width="2"/>
      <text x="140" y="430" text-anchor="middle" font-size="10" fill="#333">L Rear Door</text>
      
      <!-- Right Rear Door -->
      <path id="right-rear-door" class="car-part" data-part="Right Rear Door"
            d="M320 350 L370 350 L370 500 Q380 500 380 490 L380 450 Q380 440 370 430 L370 370 Q380 360 380 350 Z" 
            fill="#ffffff" stroke="#333" stroke-width="2"/>
      <text x="360" y="430" text-anchor="middle" font-size="10" fill="#333">R Rear Door</text>
      
      <!-- Trunk Lid -->
      <path id="trunk-lid" class="car-part" data-part="Trunk Lid"
            d="M180 500 L320 500 L350 530 Q350 550 330 570 L320 590 L180 590 L170 570 Q150 550 150 530 Z" 
            fill="#ffffff" stroke="#333" stroke-width="2"/>
      <text x="250" y="550" text-anchor="middle" font-size="12" fill="#333">Trunk</text>
      
      <!-- Left Rear Fender -->
      <path id="left-rear-fender" class="car-part" data-part="Left Rear Fender"
            d="M130 500 Q120 500 120 510 L120 560 Q120 580 140 580 L180 580 L180 540 Q160 520 150 510 Q140 500 130 500 Z" 
            fill="#ffffff" stroke="#333" stroke-width="2"/>
      <text x="140" y="545" text-anchor="middle" font-size="10" fill="#333">L Rear Fender</text>
      
      <!-- Right Rear Fender -->
      <path id="right-rear-fender" class="car-part" data-part="Right Rear Fender"
            d="M370 500 Q380 500 380 510 L380 560 Q380 580 360 580 L320 580 L320 540 Q340 520 350 510 Q360 500 370 500 Z" 
            fill="#ffffff" stroke="#333" stroke-width="2"/>
      <text x="360" y="545" text-anchor="middle" font-size="10" fill="#333">R Rear Fender</text>
      
      <!-- Rear Bumper -->
      <rect id="rear-bumper" class="car-part" data-part="Rear Bumper"
            x="180" y="590" width="140" height="30" 
            fill="#ffffff" stroke="#333" stroke-width="2" rx="15"/>
      <text x="250" y="610" text-anchor="middle" font-size="12" fill="#333">Rear Bumper</text>
      
      <!-- Wheels -->
      <circle cx="160" cy="180" r="20" fill="#666" stroke="#333" stroke-width="2"/>
      <circle cx="340" cy="180" r="20" fill="#666" stroke="#333" stroke-width="2"/>
      <circle cx="160" cy="520" r="20" fill="#666" stroke="#333" stroke-width="2"/>
      <circle cx="340" cy="520" r="20" fill="#666" stroke="#333" stroke-width="2"/>
    </svg>
  </div>
  
  <div class="legend">
    <div class="legend-item">
      <div class="legend-color" style="background-color: #ffffff; border: 2px solid #333;"></div>
      <span>Original Paint</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #dc3545;"></div>
      <span>Repainted</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #ffc107;"></div>
      <span>Portion Repainted</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #0066cc;"></div>
      <span>Foiled</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #fd7e14;"></div>
      <span>Damaged</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #6c757d;"></div>
      <span>Not Available</span>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="partModal" class="modal" style="display: none;">
  <div class="modal-content">
    <h3 id="modalTitle">Select Status</h3>
    <div class="status-options">
      <div class="status-option" data-status="Original">
        <div class="status-color" style="background-color: #ffffff; border: 2px solid #333;"></div>
        <span>Original Paint</span>
      </div>
      <div class="status-option" data-status="Painted">
        <div class="status-color" style="background-color: #dc3545;"></div>
        <span>Repainted</span>
      </div>
      <div class="status-option" data-status="Locally Painted">
        <div class="status-color" style="background-color: #ffc107;"></div>
        <span>Portion Repainted</span>
      </div>
      <div class="status-option" data-status="Replaced">
        <div class="status-color" style="background-color: #0066cc;"></div>
        <span>Foiled</span>
      </div>
      <div class="status-option" data-status="Damaged">
        <div class="status-color" style="background-color: #fd7e14;"></div>
        <span>Damaged</span>
      </div>
      <div class="status-option" data-status="None">
        <div class="status-color" style="background-color: #6c757d;"></div>
        <span>Not Available</span>
      </div>
    </div>
    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
      <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
      <button class="btn btn-primary" id="saveBtn">Save</button>
    </div>
  </div>
</div>

<form id="expertiseForm" method="POST" action="{{ url_for('reports.expertise_detail', expertise_report_id=expertise_report.id) }}">
  <input type="hidden" name="current_expertise_type" value="{{ current_expertise_type }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  
  {% for feature in expertise_report.features %}
    <input type="hidden" name="feature_{{ feature.id }}" id="feature_{{ feature.id }}" value="{{ feature.status }}">
  {% endfor %}
  
  <div class="mb-4">
    <label for="technician_comment" class="block text-gray-700 font-semibold mb-2">
      Technician Comment
    </label>
    <textarea
      id="technician_comment"
      name="technician_comment"
      rows="4"
      class="w-full p-2 border border-gray-300 rounded"
      placeholder="Enter technician comment here..."
    >{{ expertise_report.comment }}</textarea>
  </div>

  <div class="flex justify-end mt-4">
    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">
      Save
    </button>
  </div>
</form>

<style>
.car-inspection-container {
  display: flex;
  gap: 30px;
  align-items: flex-start;
  justify-content: center;
  margin: 20px 0;
  background: #f8f9fa;
  padding: 20px;
  border-radius: 10px;
}

.car-part {
  cursor: pointer;
  transition: all 0.3s ease;
}

.car-part:hover {
  opacity: 0.8;
  stroke-width: 4;
}

.legend {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  min-width: 200px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
}

.legend-color {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 2px solid #333;
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
}

.modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 20px;
  border-radius: 10px;
  min-width: 300px;
}

.status-options {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin: 15px 0;
}

.status-option {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  border: 2px solid #ddd;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.status-option:hover {
  border-color: #007bff;
  background: #f8f9fa;
}

.status-option.selected {
  border-color: #007bff;
  background: #007bff;
  color: white;
}

.status-color {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 2px solid #333;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
}

.btn-primary {
  background: #007bff;
  color: white;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

@media (max-width: 768px) {
  .car-inspection-container {
    flex-direction: column;
    align-items: center;
  }
  
  .legend {
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    min-width: auto;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let currentPart = null;
  let selectedStatus = null;

  // Feature mapping
  const partFeatureMap = {
    {% for feature in expertise_report.features %}
    '{{ feature.name }}': {{ feature.id }},
    {% endfor %}
  };

  const statusColors = {
    'Original': '#ffffff',
    'Painted': '#dc3545',
    'Locally Painted': '#ffc107',
    'Replaced': '#0066cc',
    'Damaged': '#fd7e14',
    'None': '#6c757d'
  };

  // Initialize parts with current status
  {% for feature in expertise_report.features %}
  const partName{{ loop.index }} = '{{ feature.name }}';
  const status{{ loop.index }} = '{{ feature.status }}';
  const color{{ loop.index }} = statusColors[status{{ loop.index }}] || '#ffffff';
  
  const element{{ loop.index }} = document.querySelector('[data-part="' + partName{{ loop.index }} + '"]');
  if (element{{ loop.index }}) {
    element{{ loop.index }}.style.fill = color{{ loop.index }};
  }
  {% endfor %}

  // Add click event listeners to car parts
  document.querySelectorAll('.car-part').forEach(function(element) {
    element.addEventListener('click', function() {
      const partName = this.getAttribute('data-part');
      currentPart = this;
      document.getElementById('modalTitle').textContent = partName;
      document.getElementById('partModal').style.display = 'block';
      
      // Clear previous selection
      document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'));
      selectedStatus = null;
    });
  });

  // Add click event listeners to status options
  document.querySelectorAll('.status-option').forEach(function(element) {
    element.addEventListener('click', function() {
      document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
      selectedStatus = this.getAttribute('data-status');
    });
  });

  // Cancel button
  document.getElementById('cancelBtn').addEventListener('click', function() {
    document.getElementById('partModal').style.display = 'none';
    currentPart = null;
    selectedStatus = null;
  });

  // Save button
  document.getElementById('saveBtn').addEventListener('click', function() {
    if (!currentPart || !selectedStatus) {
      alert('Please select a status');
      return;
    }
    
    const partName = currentPart.getAttribute('data-part');
    const featureId = partFeatureMap[partName];
    
    if (featureId) {
      // Update hidden form input
      const hiddenInput = document.getElementById('feature_' + featureId);
      if (hiddenInput) {
        hiddenInput.value = selectedStatus;
      }
      
      // Update visual appearance
      currentPart.style.fill = statusColors[selectedStatus];
    }
    
    document.getElementById('partModal').style.display = 'none';
    currentPart = null;
    selectedStatus = null;
  });

  // Form submission handler
  const form = document.getElementById('expertiseForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      
      fetch(this.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams(formData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Paint expertise updated successfully!');
        } else {
          alert('Update failed: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Update failed. Please check your inputs!');
      });
    });
  }
});
</script>