{% include 'report_sections/expertises/vehicle_header.html' %}

<h2 class="text-lg font-semibold mb-4">
  {{ expertise_report.expertise_type.name }} {{ _('Paint Inspection') }}
</h2>
<p class="mb-4">{{ _('Click on car parts to mark their paint condition') }}</p>

<script>
let currentPart = null;
let selectedStatus = null;

// Feature mapping
const partFeatureMap = {
  {% for feature in expertise_report.features %}
  '{{ feature.name }}': {{ feature.id }},
  {% endfor %}
};

const statusColors = {
  'Original': '#e9ecef',
  'Painted': '#dc3545',
  'Locally Painted': '#ffc107',
  'Replaced': '#28a745',
  'Damaged': '#fd7e14',
  'None': '#6c757d'
};

function openModal(partName, partElement) {
  console.log('Opening modal for:', partName);
  currentPart = partElement;
  document.getElementById('modalTitle').textContent = partName;
  document.getElementById('partModal').style.display = 'block';
  
  // Clear previous selection
  document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'));
  selectedStatus = null;
}

function closeModal() {
  document.getElementById('partModal').style.display = 'none';
  currentPart = null;
  selectedStatus = null;
}

function selectStatus(status, element) {
  document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'));
  element.classList.add('selected');
  selectedStatus = status;
  console.log('Selected status:', status);
}

function saveStatus() {
  if (!currentPart || !selectedStatus) {
    alert('Please select a status');
    return;
  }
  
  const partName = currentPart.textContent.includes('L ') ? 'Left ' + currentPart.textContent.replace('L ', '') :
                   currentPart.textContent.includes('R ') ? 'Right ' + currentPart.textContent.replace('R ', '') :
                   currentPart.textContent === 'Trunk' ? 'Trunk Lid' : currentPart.textContent;
  
  const featureId = partFeatureMap[partName];
  console.log('Part name:', partName, 'Feature ID:', featureId);
  
  if (featureId) {
    // Update hidden form input
    const hiddenInput = document.getElementById('feature_' + featureId);
    if (hiddenInput) {
      hiddenInput.value = selectedStatus;
      console.log('Updated hidden input:', hiddenInput.name, '=', selectedStatus);
    }
    
    // Update visual appearance
    currentPart.style.backgroundColor = statusColors[selectedStatus];
    console.log('Updated', partName, 'to', selectedStatus, 'with color', statusColors[selectedStatus]);
  }
  
  closeModal();
}

// Initialize parts with current status
document.addEventListener('DOMContentLoaded', function() {
  console.log('Initializing car parts...');
  {% for feature in expertise_report.features %}
  const partName = '{{ feature.name }}';
  const status = '{{ feature.status }}';
  const color = statusColors[status] || '#e9ecef';
  
  // Find the part element
  const partElements = document.querySelectorAll('.car-part');
  partElements.forEach(function(element) {
    const elementPartName = element.textContent.includes('L ') ? 'Left ' + element.textContent.replace('L ', '') :
                           element.textContent.includes('R ') ? 'Right ' + element.textContent.replace('R ', '') :
                           element.textContent === 'Trunk' ? 'Trunk Lid' : element.textContent;
    
    if (elementPartName === partName) {
      element.style.backgroundColor = color;
      console.log('Initialized', partName, 'with color', color);
    }
  });
  {% endfor %}
  
  // Form submission handler
  const form = document.getElementById('expertiseForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      
      fetch(this.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams(formData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Paint expertise updated successfully!');
        } else {
          alert('Update failed: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Update failed. Please check your inputs!');
      });
    });
  }
});
</script>

<style>
.car-container {
  display: flex;
  gap: 30px;
  align-items: flex-start;
  justify-content: center;
  margin: 20px 0;
}

.car-part {
  cursor: pointer;
  transition: all 0.3s ease;
}

.car-part:hover {
  opacity: 0.8;
  stroke-width: 3;
}

.legend {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  min-width: 200px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
}

.legend-color {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 2px solid #333;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
}

.modal-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 20px;
  border-radius: 10px;
  min-width: 300px;
}

.status-options {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin: 15px 0;
}

.status-option {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  border: 2px solid #ddd;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.status-option:hover {
  border-color: #007bff;
  background: #f8f9fa;
}

.status-option.selected {
  border-color: #007bff;
  background: #007bff;
  color: white;
}

.status-color {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 2px solid #333;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
}

.btn-primary {
  background: #007bff;
  color: white;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

/* Color classes */
.status-original { background-color: #e9ecef !important; }
.status-painted { background-color: #dc3545 !important; }
.status-locally-painted { background-color: #ffc107 !important; }
.status-replaced { background-color: #28a745 !important; }
.status-damaged { background-color: #fd7e14 !important; }
.status-not-available { background-color: #6c757d !important; }

@media (max-width: 768px) {
  .car-container {
    flex-direction: column;
    align-items: center;
  }
  
  .legend {
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    min-width: auto;
  }
}
</style>

<div class="car-container">
  <svg width="500" height="700" viewBox="0 0 500 700" xmlns="http://www.w3.org/2000/svg">
    <!-- Realistic car outline matching the original exactly -->
    
    <!-- Car main body outline -->
    <path d="M150 80 Q120 80 120 110 L120 200 Q110 210 110 220 L110 280 Q110 290 120 300 L120 400 Q110 410 110 420 L110 480 Q110 490 120 500 L120 590 Q120 620 150 620 L350 620 Q380 620 380 590 L380 500 Q390 490 390 480 L390 420 Q390 410 380 400 L380 300 Q390 290 390 280 L390 220 Q390 210 380 200 L380 110 Q380 80 350 80 Z" 
          fill="none" stroke="#333" stroke-width="3"/>
    
    <!-- Front Bumper -->
    <path class="car-part" onclick="openModal('Front Bumper', this)" 
          d="M150 80 Q120 80 120 110 L380 110 Q380 80 350 80 Z" 
          fill="#e9ecef" stroke="#333" stroke-width="2"/>
    
    <!-- Hood with windshield -->
    <path class="car-part" onclick="openModal('Hood', this)" 
          d="M140 110 L360 110 L340 200 Q250 210 160 200 Z" 
          fill="#e9ecef" stroke="#333" stroke-width="2"/>
    
    <!-- Front windshield -->
    <path d="M160 200 Q250 210 340 200 L320 240 Q250 250 180 240 Z" 
          fill="#b3d9ff" stroke="#333" stroke-width="1" opacity="0.8"/>
    
    <!-- Left Front Fender -->
    <path class="car-part" onclick="openModal('Left Front Fender', this)" 
          d="M120 110 L140 110 L160 200 L140 240 Q110 230 110 220 L110 200 Q110 180 120 160 Z" 
          fill="#e9ecef" stroke="#333" stroke-width="2"/>
    
    <!-- Right Front Fender -->
    <path class="car-part" onclick="openModal('Right Front Fender', this)" 
          d="M360 110 L380 110 L380 160 Q380 180 380 200 L380 220 Q390 230 360 240 L340 200 Z" 
          fill="#e9ecef" stroke="#333" stroke-width="2"/>
    
    <!-- Left Front Door -->
    <path class="car-part" onclick="openModal('Left Front Door', this)" 
          d="M110 220 Q110 210 120 200 L140 240 L180 240 L160 340 L140 380 Q110 370 110 360 L110 280 Q110 250 110 220 Z" 
          fill="#e9ecef" stroke="#333" stroke-width="2"/>
    
    <!-- Right Front Door -->
    <path class="car-part" onclick="openModal('Right Front Door', this)" 
          d="M380 200 Q390 210 390 220 L390 250 Q390 280 390 360 Q390 370 360 380 L340 340 L320 240 L360 240 Z" 
          fill="#e9ecef" stroke="#333" stroke-width="2"/>
    
    <!-- Roof -->
    <path class="car-part" onclick="openModal('Roof', this)" 
          d="M180 240 L320 240 L340 340 L320 460 Q250 470 180 460 L160 340 Z" 
          fill="#e9ecef" stroke="#333" stroke-width="2"/>
    
    <!-- Left Rear Door -->
    <path class="car-part" onclick="openModal('Left Rear Door', this)" 
          d="M110 360 Q110 370 120 380 L140 380 L160 340 L160 460 L140 500 Q110 490 110 480 L110 420 Q110 390 110 360 Z" 
          fill="#e9ecef" stroke="#333" stroke-width="2"/>
    
    <!-- Right Rear Door -->
    <path class="car-part" onclick="openModal('Right Rear Door', this)" 
          d="M360 380 Q390 370 390 360 L390 390 Q390 420 390 480 Q390 490 360 500 L340 460 L340 340 Z" 
          fill="#e9ecef" stroke="#333" stroke-width="2"/>
    
    <!-- Trunk with rear windshield -->
    <path class="car-part" onclick="openModal('Trunk Lid', this)" 
          d="M160 460 L320 460 Q250 470 180 460 L160 500 Q250 510 340 500 L360 590 L140 590 Z" 
          fill="#e9ecef" stroke="#333" stroke-width="2"/>
    
    <!-- Rear windshield -->
    <path d="M180 460 Q250 470 320 460 L300 500 Q250 510 200 500 Z" 
          fill="#b3d9ff" stroke="#333" stroke-width="1" opacity="0.8"/>
    
    <!-- Left Rear Fender -->
    <path class="car-part" onclick="openModal('Left Rear Fender', this)" 
          d="M110 480 Q110 490 120 500 L140 500 L140 590 L120 590 Q120 570 120 550 L120 520 Q110 510 110 480 Z" 
          fill="#e9ecef" stroke="#333" stroke-width="2"/>
    
    <!-- Right Rear Fender -->
    <path class="car-part" onclick="openModal('Right Rear Fender', this)" 
          d="M360 500 Q390 490 390 480 Q390 510 380 520 L380 550 Q380 570 380 590 L360 590 Z" 
          fill="#e9ecef" stroke="#333" stroke-width="2"/>
    
    <!-- Rear Bumper -->
    <path class="car-part" onclick="openModal('Rear Bumper', this)" 
          d="M140 590 L360 590 L380 590 Q380 620 350 620 L150 620 Q120 620 120 590 Z" 
          fill="#e9ecef" stroke="#333" stroke-width="2"/>
    
    <!-- Part labels -->
    <text x="250" y="100" text-anchor="middle" font-size="12" fill="#333">Front Bumper</text>
    <text x="250" y="160" text-anchor="middle" font-size="12" fill="#333">Hood</text>
    <text x="130" y="170" text-anchor="middle" font-size="10" fill="#333">L Front Fender</text>
    <text x="370" y="170" text-anchor="middle" font-size="10" fill="#333">R Front Fender</text>
    <text x="130" y="300" text-anchor="middle" font-size="10" fill="#333">L Front Door</text>
    <text x="370" y="300" text-anchor="middle" font-size="10" fill="#333">R Front Door</text>
    <text x="250" y="350" text-anchor="middle" font-size="12" fill="#333">Roof</text>
    <text x="130" y="430" text-anchor="middle" font-size="10" fill="#333">L Rear Door</text>
    <text x="370" y="430" text-anchor="middle" font-size="10" fill="#333">R Rear Door</text>
    <text x="250" y="540" text-anchor="middle" font-size="12" fill="#333">Trunk</text>
    <text x="130" y="540" text-anchor="middle" font-size="10" fill="#333">L Rear Fender</text>
    <text x="370" y="540" text-anchor="middle" font-size="10" fill="#333">R Rear Fender</text>
    <text x="250" y="610" text-anchor="middle" font-size="12" fill="#333">Rear Bumper</text>
  </svg>
  
  <div class="legend">
    <div class="legend-item">
      <div class="legend-color" style="background-color: #e9ecef;"></div>
      <span>{{ _('Original Paint') }}</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #dc3545;"></div>
      <span>{{ _('Repainted') }}</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #ffc107;"></div>
      <span>{{ _('Portion Repainted') }}</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #28a745;"></div>
      <span>{{ _('Replaced') }}</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #fd7e14;"></div>
      <span>{{ _('Damaged') }}</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #6c757d;"></div>
      <span>{{ _('Not Available') }}</span>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="partModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">Select Status</h3>
    <div class="status-options">
      <div class="status-option" onclick="selectStatus('Original', this)">
        <div class="status-color" style="background-color: #e9ecef;"></div>
        <span>{{ _('Original Paint') }}</span>
      </div>
      <div class="status-option" onclick="selectStatus('Painted', this)">
        <div class="status-color" style="background-color: #dc3545;"></div>
        <span>{{ _('Repainted') }}</span>
      </div>
      <div class="status-option" onclick="selectStatus('Locally Painted', this)">
        <div class="status-color" style="background-color: #ffc107;"></div>
        <span>{{ _('Portion Repainted') }}</span>
      </div>
      <div class="status-option" onclick="selectStatus('Replaced', this)">
        <div class="status-color" style="background-color: #28a745;"></div>
        <span>{{ _('Replaced') }}</span>
      </div>
      <div class="status-option" onclick="selectStatus('Damaged', this)">
        <div class="status-color" style="background-color: #fd7e14;"></div>
        <span>{{ _('Damaged') }}</span>
      </div>
      <div class="status-option" onclick="selectStatus('None', this)">
        <div class="status-color" style="background-color: #6c757d;"></div>
        <span>{{ _('Not Available') }}</span>
      </div>
    </div>
    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
      <button class="btn btn-secondary" onclick="closeModal()">{{ _('Cancel') }}</button>
      <button class="btn btn-primary" onclick="saveStatus()">{{ _('Save') }}</button>
    </div>
  </div>
</div>

<form id="expertiseForm" method="POST" action="{{ url_for('reports.expertise_detail', expertise_report_id=expertise_report.id) }}">
  <input type="hidden" name="current_expertise_type" value="{{ current_expertise_type }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  
  {% for feature in expertise_report.features %}
    <input type="hidden" name="feature_{{ feature.id }}" id="feature_{{ feature.id }}" value="{{ feature.status }}">
  {% endfor %}
  
  <div class="mb-4">
    <label for="technician_comment" class="block text-gray-700 font-semibold mb-2">
      {{ _('Technician Comment') }}
    </label>
    <textarea
      id="technician_comment"
      name="technician_comment"
      rows="4"
      class="w-full p-2 border border-gray-300 rounded"
      placeholder="{{ _('Enter technician comment here...') }}"
    >{{ expertise_report.comment }}</textarea>
  </div>

  <div class="flex justify-end mt-4">
    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">
      {{ _('Save') }}
    </button>
  </div>
</form>

