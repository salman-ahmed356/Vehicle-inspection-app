<style>
  /* General styles for form elements */
  .form-section {
    margin-bottom: 1rem;
  }
  .form-section label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: block;
  }
  .hidden {
    display: none;
  }
  .red-text {
    color: red;
    font-weight: bold;
  }
  input[type="radio"] {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    width: 24px; height: 24px;
    border: 2px solid #4A5568;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  input[type="radio"]:checked {
    border-color: #38B2AC;
    background-color: #38B2AC;
  }
  input[type="radio"]:checked::before {
    content: '';
    display: block;
    width: 12px; height: 12px;
    margin: 4px;
    background-color: #38B2AC;
    border-radius: 50%;
  }
  input[type="radio"]:hover {
    border-color: #68D391;
  }
  input[type="number"], input[type="text"], textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #CBD5E0;
    border-radius: 0.375rem;
    font-size: 1rem;
    color: #4A5568;
    outline: none;
    transition: all 0.3s ease;
  }
  input[type="number"]:focus,
  input[type="text"]:focus,
  textarea:focus {
    border-color: #38B2AC;
    box-shadow: 0 0 0 3px rgba(56,178,172,0.5);
  }
  input[type="number"]:disabled {
    background-color: #E2E8F0;
  }
  button[type="submit"] {
    background-color: #3182CE;
    color: white;
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    border-radius: 0.375rem;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button[type="submit"]:hover {
    background-color: #2B6CB0;
  }
</style>

{% include 'report_sections/expertises/vehicle_header.html' %}

<h2 class="text-lg font-semibold mb-4">{{ _('Dyno / Road Test') }}</h2>
<p class="mb-4">{{ _('Please specify which test was performed, then enter the results or comments!') }}</p>

<form id="expertiseForm" method="POST">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <!-- Test Type Selection -->
  <div class="form-section">
    <label class="red-text">{{ _('Which test was performed?') }}</label>
    <label>
      <input type="radio" name="test_type" value="dyno"
             onclick="showSection('dyno')" required
             {% if test_type == 'dyno' %}checked{% endif %}>
      {{ _('Dyno Test') }}
    </label>
    <label>
      <input type="radio" name="test_type" value="road"
             onclick="showSection('road')"
             {% if test_type == 'road' %}checked{% endif %}>
      {{ _('Road Test') }}
    </label>
  </div>

  <!-- Dyno Options -->
  <div id="dynoOptions" class="hidden">
    <div class="form-section">
      <label class="red-text">{{ _('Output Unit') }}</label>
      <label>
        <input type="radio" name="dyno_unit" value="hp"
               onclick="showSection('dyno')" 
               {% if dyno_unit == 'hp' %}checked{% endif %}>
        HP
      </label>
      <label>
        <input type="radio" name="dyno_unit" value="kw"
               onclick="showSection('dyno')" 
               {% if dyno_unit == 'kw' %}checked{% endif %}>
        KW
      </label>
    </div>
    <div class="form-section">
      {% for feature in expertise_report.features %}
        <label for="feature_{{ feature.id }}">
          {{ feature.name }} ({{ dyno_unit|upper }})
        </label>
        <input type="number"
               id="feature_{{ feature.id }}"
               name="feature_{{ feature.id }}"
               value="{{ feature.status }}"
               step="any" min="0">
      {% endfor %}
    </div>
  </div>

  <!-- Road Test Fields -->
  <div id="roadOptions" class="hidden">
    {% set road_statuses = [
         'None',
         '(Good) Passed Inspection',
         '(Moderate) May Cause Issues',
         '(Bad) Maintenance Required'
       ]
    %}
    <div class="form-section">
      {% for feature in expertise_report.features %}
        <label class="block font-semibold mb-1">{{ feature.name }}</label>
        <div>
          {% for status in road_statuses %}
            <label>
              <input type="radio"
                     name="feature_{{ feature.id }}"
                     value="{{ status }}"
                     {% if feature.status == status %}checked{% endif %}>
              {{ _(status) }}
            </label>
          {% endfor %}
        </div>
      {% endfor %}
    </div>
    <div class="form-section">
      <label for="technician_comment" class="font-semibold mb-1">
        {{ _('Technician Comment') }}
      </label>
      <textarea id="technician_comment"
                name="technician_comment"
                rows="4">{{ expertise_report.comment }}</textarea>
    </div>
  </div>

  <div class="text-right mt-4">
    <button type="submit">{{ _('Save') }}</button>
  </div>
</form>

<script>
  function showSection(type) {
    document.getElementById('dynoOptions').classList.toggle('hidden', type !== 'dyno');
    document.getElementById('roadOptions').classList.toggle('hidden', type !== 'road');
  }

  document.addEventListener('DOMContentLoaded', function() {
    const initType = '{{ test_type }}';
    if (initType === 'dyno' || initType === 'road') {
      showSection(initType);
    }

    $('#expertiseForm').on('submit', function(e) {
      e.preventDefault();
      $.post(
        "{{ url_for('reports.expertise_detail', expertise_report_id=expertise_report.id) }}",
        $(this).serialize()
      )
      .done(() => alert("{{ _('Expertise updated successfully!') }}"))
      .fail(() => alert("{{ _('Update failed. Please check your inputs.') }}"));
    });
  });
</script>
