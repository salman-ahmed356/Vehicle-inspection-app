<style>
  /* General Styles */
  .expertise-section {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
  }
  .form-section {
    width: 50%;
  }
  .car-image-section {
    width: 40%;
    text-align: center;
  }
  .form-group {
    margin-bottom: 1.5rem;
  }
  .form-group label {
    font-weight: bold;
    margin-bottom: 0.5rem;
    display: block;
  }
  .dropdown {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #CBD5E0;
    border-radius: 0.375rem;
    font-size: 1rem;
    color: #4A5568;
    cursor: pointer;
    transition: border-color 0.3s ease;
  }
  .dropdown:hover,
  .dropdown:focus {
    border-color: #3182CE;
  }
  .extra-conditions {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: #718096;
  }
  .extra-conditions span {
    background-color: #EDF2F7;
    padding: 0.2rem 0.5rem;
    border-radius: 0.25rem;
    margin-right: 0.5rem;
  }
  .car-image {
    max-width: 100%;
    margin-top: 1.5rem;
  }
  .feature-selected {
    background-color: #38B2AC;
    color: white;
    font-weight: bold;
    text-align: center;
    padding: 0.75rem;
    border-radius: 0.375rem;
  }
</style>

{% include 'report_sections/expertises/vehicle_header.html' %}

<h2 class="text-lg font-semibold mb-4">
  {{ expertise_report.expertise_type.name }} {{ _('Paint Inspection') }}
</h2>
<p class="mb-4">{{ _('Please specify the condition of each painted area!') }}</p>

<div class="expertise-section">
  <div class="form-section">
    <form id="expertiseForm" method="POST">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      {# Paint‚Äêspecific statuses in English #}
      {% set status_choices = [
           'Original',
           'Plastic',
           'Painted',
           'Locally Painted',
           'Replaced',
           'Coated',
           'None'
         ]
      %}

      {% for feature in expertise_report.features %}
        <div class="form-group feature-{{ feature.id }}">
          <label for="feature-status-{{ feature.id }}">
            {{ feature.name }}
          </label>
          <select
            class="dropdown"
            id="feature-status-{{ feature.id }}"
            name="feature_{{ feature.id }}"
          >
            {% for s in status_choices %}
              <option
                value="{{ s }}"
                {% if feature.status == s %}selected{% endif %}
              >{{ _(s) }}</option>
            {% endfor %}
          </select>
          <div class="extra-conditions" id="extra-conditions-{{ feature.id }}"></div>
        </div>
      {% endfor %}

      <div class="flex justify-end mt-4">
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">
          {{ _('Save') }}
        </button>
      </div>
    </form>
  </div>

  <div class="car-image-section">
    <img
      src="https://placehold.co/400x300"
      alt="{{ _('Car Image') }}"
      class="car-image"
    >
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Pull Jinja status_choices into JS
    const statusChoices = [
      {% for s in status_choices %}
        "{{ s }}"{% if not loop.last %},{% endif %}
      {% endfor %}
    ];
    const extrasList = [
      '{{ _("DISASSEMBLED / REASSEMBLED") }}',
      '{{ _("PAINTLESS DENT") }}',
      '{{ _("DENT/SCRATCH") }}',
      '{{ _("CLEARCOAT") }}'
    ];

    document.querySelectorAll(".form-group").forEach(function(group) {
      const dropdown = group.querySelector(".dropdown");
      const extraDiv = group.querySelector(".extra-conditions");

      function updateExtras() {
        const val = dropdown.value;
        let picks = [];
        if (val !== statusChoices[0]) {
          picks = extrasList
            .slice(0, Math.floor(Math.random() * extrasList.length) + 1);
        }
        extraDiv.innerHTML = picks.map(x => `<span>${x}</span>`).join("");
        group.classList.toggle("feature-selected", val !== statusChoices[0]);
      }

      dropdown.addEventListener("change", updateExtras);
      updateExtras();
    });

    // AJAX save
    document.getElementById("expertiseForm").addEventListener("submit", function(e) {
      e.preventDefault();
      fetch("{{ url_for('reports.expertise_detail', expertise_report_id=expertise_report.id) }}", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams(new FormData(this))
      })
      .then(r => r.json())
      .then(resp => {
        if (resp.success) {
          alert("{{ _('Paint status updated successfully!') }}");
        } else {
          alert("{{ _('An error occurred during update.') }}");
        }
      })
      .catch(() => {
        alert("{{ _('Report could not be updated. Please ensure there are no issues!') }}");
      });
    });
  });
</script>
